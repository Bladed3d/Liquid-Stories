<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monster 02 â†’ Resolution - Liquid Paint V7</title>
</head>
<body>
    <script src="../timeline-component.js"></script>

    <script>
        // Include the base liquid paint system
        fetch('../liquid-paint-base.html')
            .then(response => response.text())
            .then(html => {
                // Extract and inject the base HTML content
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Copy styles
                doc.querySelectorAll('style').forEach(style => {
                    document.head.appendChild(style.cloneNode(true));
                });

                // Copy body content
                doc.body.querySelectorAll('*').forEach(element => {
                    document.body.appendChild(element.cloneNode(true));
                });

                // Wait for scripts to load, then initialize
                setTimeout(() => {
                    initializeTransformation();
                }, 100);
            });

        function initializeTransformation() {
            // Initialize timeline for this stage
            const timeline = initTimeline({
                currentStage: 4,
                totalStages: 4,
                interactive: false,
                onStageChange: (stage) => {
                    console.log(`Stage changed to: ${stage}`);
                }
            });

            // Configure liquid paint system for this transformation
            const config = {
                image1Url: '../images/Monster02.png',
                image2Url: '../images/KidHappy.png', // Resolution returns to happy kid
                backboardUrl: '../backboard-4.html',
                stageTitle: 'Monster 02 â†’ Resolution',
                imageCount: 10000 // Desktop count
            };

            // Initialize the liquid paint system
            if (typeof window.initializeLiquidPaint === 'function') {
                window.initializeLiquidPaint(config);
            } else {
                // Wait for the function to be available
                setTimeout(() => {
                    if (typeof window.initializeLiquidPaint === 'function') {
                        window.initializeLiquidPaint(config);
                    } else {
                        console.error('initializeLiquidPaint function not available');
                    }
                }, 500);
            }

            // Global function for timeline progress updates
            window.updateTimelineProgress = function(percentage) {
                if (timeline && typeof timeline.trackParticleTransformation === 'function') {
                    // Convert percentage to particle count for timeline
                    const totalParticles = config.imageCount;
                    const transformedCount = Math.round((percentage / 100) * totalParticles);
                    timeline.trackParticleTransformation(transformedCount, totalParticles);
                }
            };

            // Handle completion of final stage - show completion message
            const originalComplete = window.autoCompleteTransformation;
            window.autoCompleteTransformation = function() {
                // Call the original function
                if (originalComplete) originalComplete();

                // Show completion celebration for entire story
                setTimeout(() => {
                    showStoryCompletion();
                }, 1000);
            };

            function showStoryCompletion() {
                const completionDiv = document.createElement('div');
                completionDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(45deg, #fe802d, #fe0048);
                    color: white;
                    padding: 40px 60px;
                    border-radius: 20px;
                    text-align: center;
                    z-index: 2000;
                    box-shadow: 0 20px 60px rgba(254, 0, 72, 0.5);
                    animation: popIn 0.5s ease forwards;
                `;
                completionDiv.innerHTML = `
                    <h2 style="font-size: 2.5rem; margin-bottom: 20px;">ðŸŽ‰ Story Complete! ðŸŽ‰</h2>
                    <p style="font-size: 1.3rem; opacity: 0.9;">You've completed the Liquid Stories journey!</p>
                    <button onclick="this.parentElement.remove()" style="
                        margin-top: 30px;
                        padding: 15px 30px;
                        background: white;
                        color: #fe0048;
                        border: none;
                        border-radius: 10px;
                        font-size: 1.1rem;
                        font-weight: bold;
                        cursor: pointer;
                    ">Close</button>
                `;

                document.body.appendChild(completionDiv);

                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (completionDiv.parentElement) {
                        completionDiv.remove();
                    }
                }, 10000);
            }

            console.log('Transformation 4â†’5 initialized: Monster 02 â†’ Resolution');
        }
    </script>
</body>
</html>