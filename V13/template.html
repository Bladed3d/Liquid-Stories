<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{STORY_TITLE}} - Page {{PAGE_NUMBER}}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: white; overflow: hidden; cursor: none; user-select: none; -webkit-user-select: none; touch-action: none; }
        .hero { position: relative; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #backgroundCanvas { position: absolute; inset: 0; z-index: 1; background: #0a0a0a; }
        #fluidCanvas { position: absolute; inset: 0; z-index: 2; background: transparent; }
        .universal-puck { position: fixed; width: 60px; height: 60px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(255,255,255,0.5), rgba(255,255,255,0.1)); border: 3px solid rgba(255,255,255,0.8); box-shadow: 0 0 20px rgba(255,255,255,0.5), 0 0 40px rgba(255,255,255,0.3); pointer-events: none; z-index: 1000; transform: translate(-50%, -50%); display: block; left: 50%; top: 50%; }
        .universal-puck.dragging { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 0 30px rgba(255,255,255,0.8), 0 0 60px rgba(255,255,255,0.5); }
        .universal-puck.desktop-following { transform: translate(-50%, -50%) scale(1.0); }

        /* Combined Progress Timeline */
        .progress-timeline { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); padding: 7.5px 12.5px; border-radius: 6px; text-align: center; z-index: 100; border: 1px solid rgba(255, 255, 255, 0.2); min-width: 250px; max-width: 90vw; }
        .progress-title { font-size: 0.9rem; margin-bottom: 4px; opacity: 0.9; }
        .progress-text { font-size: 0.8rem; font-weight: bold; color: #fe0048; text-shadow: 0 0 5px rgba(254, 0, 72, 0.5); margin-top: 2px; }

        .timeline-wrapper { position: relative; display: flex; align-items: center; justify-content: space-between; margin: 6px 0; padding: 0 5px; }

        .timeline-node { width: 25px; height: 25px; border-radius: 50%; border: 1.5px solid #444; display: flex; align-items: center; justify-content: center; font-size: 0.45rem; font-weight: bold; transition: all 0.3s ease; position: relative; cursor: pointer; z-index: 2; background: rgba(10, 10, 10, 0.9); }
        .timeline-node.completed { border-color: #00ff00; background: rgba(0, 255, 0, 0.2); color: #00ff00; }
        .timeline-node.current { border-color: #fe802d; background: rgba(254, 128, 45, 0.3); color: #fe802d; box-shadow: 0 0 7.5px rgba(254, 128, 45, 0.5); animation: pulse 2s infinite; }
        .timeline-node.future { border-color: #666; background: rgba(102, 102, 102, 0.1); color: #666; }

        .progress-bar-container { position: absolute; top: 50%; left: 12.5px; right: 12.5px; height: 4px; background: rgba(255, 255, 255, 0.2); border-radius: 2px; transform: translateY(-50%); z-index: 1; }
        .progress-bar-fill { height: 100%; background: #fe0048; border-radius: 2px; transition: width 0.5s ease; width: 0%; }

        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        /* Other UI Elements */
        .puck-instructions { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.9); padding: 12px 20px; border-radius: 12px; text-align: center; z-index: 50; max-width: 90%; border: 1px solid rgba(255, 255, 255, 0.2); }
        .puck-instructions h4 { margin-bottom: 6px; font-size: 0.9rem; opacity: 1; }
        .puck-instructions p { font-size: 0.8rem; opacity: 0.8; line-height: 1.4; }
        .hamburger-menu { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; z-index: 1001; transition: all 0.3s ease; }
        .hamburger-menu:hover { background: rgba(255, 255, 255, 0.2); transform: scale(1.05); }
        .hamburger-line { width: 24px; height: 2px; background: white; margin: 2px 0; transition: all 0.3s ease; }
        .menu-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 1002; display: none; align-items: center; justify-content: center; }
        .menu-backdrop.active { display: flex; }
        .menu-panel { background: rgba(20, 20, 20, 0.98); backdrop-filter: blur(20px); border-radius: 20px; padding: 24px; max-width: 400px; width: 90%; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); }
        .menu-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .menu-header h3 { font-size: 1.2rem; background: linear-gradient(45deg, #fe802d, #fe0048); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .close-menu { width: 36px; height: 36px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .close-menu:hover { background: rgba(255, 0, 72, 0.2); border-color: #fe0048; }
        .menu-controls { display: flex; flex-direction: column; gap: 12px; }
        .menu-control-btn { padding: 16px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; font-size: 1rem; font-weight: 500; text-align: center; min-height: 50px; }
        .menu-control-btn:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }
        .mobile-controls { display: flex; flex-direction: column; gap: 8px; }
        .desktop-controls { display: flex; flex-direction: column; gap: 12px; }
        .loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.9); padding: 20px; border-radius: 12px; text-align: center; z-index: 2000; border: 1px solid rgba(255, 255, 255, 0.2); }
        .logo-hover-prompt { position: fixed; background: rgba(0, 0, 0, 0.9); color: white; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: bold; z-index: 1500; pointer-events: none; border: 2px solid rgba(255, 255, 255, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); animation: fadeIn 0.3s ease; }
        .logo-hover-prompt.mobile-clickable { pointer-events: auto; cursor: pointer; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <section class="hero">
        <canvas id="backgroundCanvas"></canvas>
        <canvas id="fluidCanvas"></canvas>
    </section>

    <!-- Combined Progress Timeline -->
    <div class="progress-timeline" id="progressTimeline">
        <div class="progress-title" id="progressTitle">{{PROGRESS_TITLE}}</div>

        <div class="timeline-wrapper" id="timelineWrapper">
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBarFill"></div>
            </div>
        </div>

        <div class="progress-text" id="progressText">0% Revealed</div>
    </div>

    <div class="puck-instructions" id="puckInstructions">
        <h4>Move to Reveal</h4>
        <p>Drag your finger or mouse to uncover the hidden image</p>
    </div>

    <div class="hamburger-menu" id="hamburgerMenu">
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
    </div>

    <div class="menu-backdrop" id="menuBackdrop">
        <div class="menu-panel">
            <div class="menu-header">
                <h3>Story Controls</h3>
                <div class="close-menu" id="closeMenu">âœ•</div>
            </div>
            <div class="mobile-controls" id="mobileControls" style="display: none;">
                <button class="menu-control-btn" onclick="toggleTrails()">
                    <span id="trailsToggleText">Enable Trails</span>
                </button>
            </div>
            <div class="desktop-controls" id="desktopControls">
                <button class="menu-control-btn" onclick="toggleTrails()">
                    <span id="trailsToggleText">Enable Trails</span>
                </button>
                <div style="margin-top: 8px;">
                    <label class="toggle-label">Influence Radius</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 0.8rem;">Small</span>
                        <input type="range" class="influence-slider" id="influenceSlider" min="60" max="150" value="105">
                        <span style="font-size: 0.8rem;">Large</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">Loading dual image system...</div>

    <div class="logo-hover-prompt" id="logoHoverPrompt" style="display: none;" onclick="handleLogoPromptClick()">
        Tap here to go to GameStop
    </div>

    <script>
        // Story Configuration (Python-generated)
        const storyConfig = {{STORY_CONFIG}};

        const image1Url = 'images/{{IMAGE1_URL}}';
        const image2Url = 'images/{{IMAGE2_URL}}';
        const backboardTexts = {{BACKBOARD_TEXTS}};
        {{LOGO_URL_DECLARATION}}
        {{LOGO_TARGET_URL}}
        const totalPages = storyConfig.pages.length;
        const currentPage = {{PAGE_NUMBER}};
        const isLastPage = currentPage >= totalPages;

        // Core variables
        const canvas = document.getElementById('fluidCanvas');
        const ctx = canvas.getContext('2d');
        const bgCanvas = document.getElementById('backgroundCanvas');
        const bgCtx = bgCanvas.getContext('2d');
        const universalPuck = document.getElementById('universalPuck');
        const progressTitle = document.getElementById('progressTitle');
        const progressFill = document.getElementById('progressBarFill');
        const progressText = document.getElementById('progressText');
        const puckInstructions = document.getElementById('puckInstructions');
        const hamburgerMenu = document.getElementById('hamburgerMenu');
        const menuBackdrop = document.getElementById('menuBackdrop');
        const desktopControls = document.getElementById('desktopControls');
        const loading = document.getElementById('loading');

        let particles = [];
        let img1 = new Image();
        let img2 = new Image();
        let imageLoaded = false;

        // Touch variables
        let touchStartTime = 0;
        let touchOnLogo = false;
        let touchHoldTimer = null;
        let countdownTimer = null;
        let countdownInterval = null;
        let countdownValue = 3;
        let isCountingDown = false;

        // Logo interaction variables
        let logoPosition = null;
        let isHoveringOverLogo = false;
        const logoHoverPrompt = document.getElementById('logoHoverPrompt');
        const countdownModal = document.getElementById('countdownModal');

        // Device detection and compatibility
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const hasHover = window.matchMedia('(hover: hover)').matches;
        const isMobileDevice = isMobile || !hasHover;

        // Touch and mouse state management
        let puckActive = false;
        let mouseInCanvas = false;
        let puckX = window.innerWidth / 2;
        let puckY = window.innerHeight / 2;
        let prevPuckX = puckX;
        let prevPuckY = puckY;
        let puckVelX = 0;
        let puckVelY = 0;
        let mouseVelX = 0;
        let mouseVelY = 0;
        let transformationComplete = false;

        // Physics and interaction
        const PARTICLE_COUNT = 2500;
        const INFLUENCE_RADIUS = parseInt(storyConfig.story?.influenceRadius || '105');
        let trails = [];
        let maxTrails = isMobileDevice ? 8 : 12;
        let mobileMenuOpen = false;

        // Touch hold detection variables
        let touchStartTime = 0;
        let touchOnLogo = false;
        let touchHoldTimer = null;

        // Menu and UI state
        let influenceRadius = INFLUENCE_RADIUS;

        // Update timeline node statuses
        function updateTimelineStatus() {
            const timelineNodes = document.querySelectorAll('.timeline-node');
            const image2Count = particles.filter(p => p.currentImage === 2).length;
            const currentPercentage = Math.round((image2Count / particles.length) * 100);

            const currentPageSegment = (currentPage - 1) + (currentPercentage / 100);
            const totalSegments = totalPages;

            timelineNodes.forEach((node, index) => {
                const nodeNumber = index + 1;
                const isCompleted = nodeNumber < currentPage;
                const isCurrent = nodeNumber === currentPage;
                const isFuture = nodeNumber > currentPage;

                node.classList.toggle('completed', isCompleted || (isCurrent && currentPercentage > 0));
                node.classList.toggle('current', isCurrent && currentPercentage === 0);
                node.classList.toggle('future', isFuture && !(isCurrent && currentPercentage === 0));

                if (!node.textContent) {
                    node.textContent = nodeNumber;
                }
            });
        }

        // Initialize timeline nodes
        function initializeTimeline() {
            const timelineWrapper = document.getElementById('timelineWrapper');
            timelineWrapper.innerHTML = '<div class="progress-bar-container"><div class="progress-bar-fill" id="progressBarFill"></div></div>';

            for (let i = 1; i <= totalPages; i++) {
                const node = document.createElement('div');
                node.className = 'timeline-node';
                node.textContent = i;
                node.addEventListener('click', () => {
                    if (i < currentPage) {
                        window.location.href = `page-${i}.html`;
                    }
                });
                timelineWrapper.appendChild(node);
            }

            updateTimelineStatus();
        }

        // Mobile menu
        function toggleMobileMenu() {
            mobileMenuOpen = !mobileMenuOpen;
            menuBackdrop.classList.toggle('active', mobileMenuOpen);
        }
        function closeMobileMenu() {
            mobileMenuOpen = false;
            menuBackdrop.classList.remove('active');
        }

        // Control functions
        function saveInfluenceToConfig(value) {
            try {
                localStorage.setItem('pug-day-influence', value);
                console.log('Influence setting saved to localStorage');
            } catch (e) {
                console.log('Could not save influence setting');
            }
        }

        function loadInfluenceFromConfig() {
            try {
                const saved = localStorage.getItem('pug-day-influence');
                if (saved !== null) {
                    influenceRadius = parseInt(saved, 10);
                } else {
                    console.log('Using default influence setting');
                }
            } catch (e) {
                console.log('Could not load influence setting, using default');
            }
        }

        // Update progress
        function updateProgress() {
            const image2Count = particles.filter(p => p.currentImage === 2).length;
            const percentage2 = Math.round((image2Count / particles.length) * 100);

            const currentProgressElement = document.getElementById('progressBarFill');
            if (currentProgressElement) {
                const currentSegment = (currentPage - 1) + (percentage2 / 100);
                const totalSegments = totalPages;
                const overallProgress = Math.min(100, (currentSegment / totalSegments) * 100);

                currentProgressElement.style.width = overallProgress + '%';
                updateTimelineStatus();
            }

            progressText.textContent = percentage2 + '% Revealed';

            if (percentage2 === 100 && !transformationComplete) {
                completeTransformation(2);
                if (!isLastPage) {
                    setTimeout(() => {
                        window.location.href = `page-${currentPage + 1}.html`;
                    }, 2000);
                }
            }
        }

        // Particle system
        function createParticle(x, y) {
            return {
                x, y,
                size: Math.random() * 3 + 1,
                speedX: (Math.random() - 0.5) * 2,
                speedY: (Math.random() - 0.5) * 2,
                currentImage: 1,
                opacity: 1,
                life: 1,
                transitionSpeed: 0.02
            };
        }

        function initParticles() {
            particles = [];
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                particles.push(createParticle(Math.random() * canvas.width, Math.random() * canvas.height));
            }
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.speedX * 0.5;
                p.y += p.speedY * 0.5;
                p.speedX *= 0.99;
                p.speedY *= 0.99;

                if (p.x < 0 || p.x > canvas.width || p.y < 0 || p.y > canvas.height) {
                    particles[i] = createParticle(Math.random() * canvas.width, Math.random() * canvas.height);
                }
            }
        }

        function drawPuck(x, y) {
            const gradient = ctx.createRadialGradient(x, y, 0, x, y, influenceRadius);
            const imageData1 = ctx.getImageData(x - influenceRadius, y - influenceRadius, influenceRadius * 2, influenceRadius * 2);
            const imageData2 = ctx.getImageData(x - influenceRadius, y - influenceRadius, influenceRadius * 2, influenceRadius * 2);

            for (let i = 0; i < particles.length; i++) {
                const p = particles[i];
                const dx = p.x - x;
                const dy = p.y - y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < influenceRadius && p.currentImage === 1) {
                    const influence = 1 - (distance / influenceRadius);
                    if (Math.random() < influence * 0.3) {
                        p.currentImage = 2;
                    }
                }
            }

            if (trails.length > maxTrails) {
                trails.shift();
            }
            trails.push({ x, y, life: 1.0 });

            updateProgress();
        }

        // Canvas setup
        function resizeCanvases() {
            canvas.width = bgCanvas.width = window.innerWidth;
            canvas.height = bgCanvas.height = window.innerHeight;
            drawCouponBackground();
            if (imageLoaded) initParticles();
        }
        window.addEventListener('resize', resizeCanvases);

        function drawCouponBackground() {
            bgCtx.fillStyle = '#0a0a0a';
            bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);
            bgCtx.font = 'bold 56px Arial';
            bgCtx.textAlign = 'center';
            bgCtx.textBaseline = 'middle';
            backboardTexts.forEach(line => {
                bgCtx.fillStyle = line.color;
                bgCtx.font = `bold ${line.size}px Arial`;
                bgCtx.fillText(line.text, bgCanvas.width / 2, bgCanvas.height / 2 + line.yOffset);
            });

            {{LOGO_RENDERING_CODE}}
        }

        function completeTransformation(targetImage) {
            transformationComplete = true;
            for (let p of particles) {
                p.currentImage = targetImage;
            }
        }

        // Main draw loop
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (!imageLoaded) {
                requestAnimationFrame(draw);
                return;
            }

            const imgToDraw1 = img1.complete && img1.naturalHeight !== 0 ? img1 : createMissingImageDemo('Missing Image 1');
            const imgToDraw2 = img2.complete && img2.naturalHeight !== 0 ? img2 : createMissingImageDemo('Missing Image 2');

            for (let p of particles) {
                ctx.globalAlpha = p.opacity * p.life;
                if (p.currentImage === 1) {
                    ctx.drawImage(imgToDraw1, p.x - p.size / 2, p.y - p.size / 2, p.size, p.size);
                } else {
                    ctx.drawImage(imgToDraw2, p.x - p.size / 2, p.y - p.size / 2, p.size, p.size);
                }
            }

            // Draw trails
            ctx.globalAlpha = 0.3;
            for (let trail of trails) {
                trail.life *= 0.95;
                ctx.globalAlpha = trail.life * 0.3;
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 20;
                ctx.beginPath();
                ctx.arc(trail.x, trail.y, influenceRadius * 0.3, 0, Math.PI * 2);
                ctx.stroke();
            }

            ctx.globalAlpha = 1;

            if (puckActive) {
                drawPuck(puckX, puckY);
            }

            updateParticles();
            requestAnimationFrame(draw);
        }

        // Helper functions
        function createMissingImageDemo(text) {
            const demoCanvas = document.createElement('canvas');
            demoCanvas.width = 200;
            demoCanvas.height = 200;
            const demoCtx = demoCanvas.getContext('2d');
            demoCtx.fillStyle = '#333';
            demoCtx.fillRect(0, 0, 200, 200);
            demoCtx.fillStyle = '#fff';
            demoCtx.font = '14px Arial';
            demoCtx.textAlign = 'center';
            demoCtx.fillText(text, 100, 100);
            return demoCanvas;
        }

        function checkImagesLoaded() {
            loadedImages++;
            if (loadedImages === 2) {
                imageLoaded = true;
                loading.style.display = 'none';
                initParticles();
                loadInfluenceFromConfig();
                setupInfluenceSlider();
            }
        }

        function loadInfluenceFromConfig() {
            try {
                const saved = localStorage.getItem('pug-day-influence');
                if (saved !== null) {
                    influenceRadius = parseInt(saved, 10);
                } else {
                    console.log('Using default influence setting');
                }
            } catch (e) {
                console.log('Could not load influence setting, using default');
            }
        }

        // Touch handlers
        function handlePuckStart(e) {
            if (isMobileDevice) {
                puckInstructions.style.display = 'none';
                puckActive = true;
                const touch = e.touches[0];
                puckX = prevPuckX = touch.clientX;
                puckY = prevPuckY = touch.clientY;
                universalPuck.style.left = puckX + 'px';
                universalPuck.style.top = puckY + 'px';
                universalPuck.classList.add('dragging');

                // Reset touch detection variables
                touchStartTime = Date.now();
                touchOnLogo = isOverLogo(puckX, puckY);

                if (touchOnLogo) {
                    touchHoldTimer = setTimeout(() => {
                        if (touchOnLogo && !isCountingDown) {
                            startCountdown();
                        }
                    }, 500);
                }
            }
        }

        function handlePuckMove(e) {
            if (isMobileDevice && puckActive) {
                const touch = e.touches[0];
                prevPuckX = puckX; prevPuckY = puckY;
                puckX = touch.clientX; puckY = touch.clientY;
                universalPuck.style.left = puckX + 'px';
                universalPuck.style.top = puckY + 'px';
                universalPuck.classList.add('dragging');
                puckVelX = puckX - prevPuckX; puckVelY = puckY - prevPuckY;
                updateProgress();

                // Check logo hover for mobile
                checkLogoHover(puckX, puckY);

                // Track if user moves off logo while touching
                const wasOnLogo = touchOnLogo;
                touchOnLogo = isOverLogo(puckX, puckY);

                // If user moves off logo while holding, cancel the hold timer
                if (wasOnLogo && !touchOnLogo && touchHoldTimer) {
                    clearTimeout(touchHoldTimer);
                    touchHoldTimer = null;
                }
            }
        }

        function handlePuckEnd() {
            if (isMobileDevice) {
                puckActive = false;
                puckVelX = puckVelY = 0;
                universalPuck.classList.remove('dragging');

                // Cancel countdown if user releases early
                cancelCountdown();

                // Reset touch tracking
                touchOnLogo = false;
                touchStartTime = 0;
            }
        }

        // Desktop mouse handlers
        function handleDesktopMouseMove(e) {
            if (!isMobileDevice) {
                prevPuckX = puckX; prevPuckY = puckY;
                puckX = e.clientX; puckY = e.clientY;
                universalPuck.style.left = puckX + 'px';
                universalPuck.style.top = puckY + 'px';
                universalPuck.classList.add('desktop-following');

                if (mouseInCanvas) {
                    puckVelX = puckX - prevPuckX; puckVelY = puckY - prevPuckY;
                    updateProgress();
                }

                // Check logo hover for desktop
                checkLogoHover(puckX, puckY);
            }
        }

        function handleDesktopMouseDown() {
            if (!isMobileDevice) {
                mouseInCanvas = true;
                universalPuck.classList.add('dragging');
                universalPuck.classList.remove('desktop-following');
            }
        }

        function handleDesktopMouseUp() {
            if (!isMobileDevice) {
                mouseInCanvas = false;
                universalPuck.classList.remove('dragging', 'desktop-following');
            }
        }

        function handleDesktopMouseLeave() {
            if (!isMobileDevice) {
                mouseInCanvas = false;
                universalPuck.classList.remove('dragging', 'desktop-following');
            }
        }

        // Logo hover detection
        function checkLogoHover(mouseX, mouseY) {
            if (!logoPosition) {
                hideLogoHoverPrompt();
                return;
            }

            const isOverLogo = mouseX >= logoPosition.x &&
                              mouseX <= logoPosition.x + logoPosition.width &&
                              mouseY >= logoPosition.y &&
                              mouseY <= logoPosition.y + logoPosition.height;

            if (isOverLogo && !isHoveringOverLogo) {
                isHoveringOverLogo = true;
                showLogoHoverPrompt(mouseX, mouseY);
            } else if (!isOverLogo && isHoveringOverLogo) {
                isHoveringOverLogo = false;
                hideLogoHoverPrompt();
            } else if (isOverLogo && isHoveringOverLogo) {
                updateLogoHoverPromptPosition(mouseX, mouseY);
            }
        }

        function showLogoHoverPrompt(mouseX, mouseY) {
            if (typeof logoTargetUrl !== 'undefined') {
                if (isMobileDevice) {
                    logoHoverPrompt.textContent = 'Tap here to go to GameStop';
                    logoHoverPrompt.classList.add('mobile-clickable');
                } else {
                    logoHoverPrompt.textContent = `Press 1 to visit ${logoTargetUrl}`;
                    logoHoverPrompt.classList.remove('mobile-clickable');
                }
                logoHoverPrompt.style.display = 'block';
                updateLogoHoverPromptPosition(mouseX, mouseY);
            }
        }

        function hideLogoHoverPrompt() {
            logoHoverPrompt.style.display = 'none';
        }

        // Handle click/tap on logo hover prompt for mobile users
        function handleLogoPromptClick() {
            if (isMobileDevice && typeof logoTargetUrl !== 'undefined') {
                window.open(logoTargetUrl, '_blank');
            }
        }

        function updateLogoHoverPromptPosition(mouseX, mouseY) {
            logoHoverPrompt.style.left = (mouseX + 15) + 'px';
            logoHoverPrompt.style.top = (mouseY - 40) + 'px';
        }

        function isOverLogo(x, y) {
            if (!logoPosition) return false;

            return x >= logoPosition.x &&
                   x <= logoPosition.x + logoPosition.width &&
                   y >= logoPosition.y &&
                   y <= logoPosition.y + logoPosition.height;
        }

        // Countdown functions for mobile interaction
        function startCountdown() {
            isCountingDown = true;
            countdownValue = 3;
            countdownModal.classList.add('active');
            countdownTimerDisplay.textContent = countdownValue;

            countdownInterval = setInterval(() => {
                countdownValue--;
                countdownTimerDisplay.textContent = countdownValue;

                if (countdownValue <= 0) {
                    clearInterval(countdownInterval);
                    openGameStopWebsite();
                    hideCountdownModal();
                    isCountingDown = false;
                }
            }, 1000);
        }

        function cancelCountdown() {
            if (isCountingDown) {
                clearInterval(countdownInterval);
                hideCountdownModal();
                isCountingDown = false;
            }
        }

        function hideCountdownModal() {
            countdownModal.classList.remove('active');
        }

        function openGameStopWebsite() {
            if (typeof logoTargetUrl !== 'undefined') {
                window.open(logoTargetUrl, '_blank');
            }
        }

        // Keyboard event handler for logo navigation
        function handleKeyPress(event) {
            if (event.key === '1' && isHoveringOverLogo && typeof logoTargetUrl !== 'undefined') {
                window.open(logoTargetUrl, '_blank');
            }
        }

        // Control functions
        function toggleTrails() {
            trails.length = 0;
            const trailsToggle = document.getElementById('trailsToggle');
            const trailsToggleText = document.getElementById('trailsToggleText');
            trailsToggle.classList.toggle('active');
            trailsToggleText.textContent = trailsToggle.classList.contains('active') ? 'Disable Trails' : 'Enable Trails';
        }

        function setupInfluenceSlider() {
            const slider = document.getElementById('influenceSlider');
            if (slider) {
                slider.value = influenceRadius;
                slider.addEventListener('input', (e) => {
                    influenceRadius = parseInt(e.target.value);
                    saveInfluenceToConfig(influenceRadius);
                });
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            initializeTimeline();
            resizeCanvases();
            draw();

            img1.onload = checkImagesLoaded;
            img2.onload = checkImagesLoaded;
            img1.onerror = checkImagesLoaded;
            img2.onerror = checkImagesLoaded;

            img1.src = image1Url;
            img2.src = image2Url;

            // Touch events
            if (isMobileDevice) {
                document.addEventListener('touchstart', handlePuckStart, { passive: false });
                document.addEventListener('touchmove', handlePuckMove, { passive: false });
                document.addEventListener('touchend', handlePuckEnd, { passive: false });

                mobileControls.style.display = 'flex';
                desktopControls.style.display = 'none';
            } else {
                document.addEventListener('mousemove', handleDesktopMouseMove);
                document.addEventListener('mousedown', handleDesktopMouseDown);
                document.addEventListener('mouseup', handleDesktopMouseUp);
                document.addEventListener('mouseleave', handleDesktopMouseLeave);

                desktopControls.style.display = 'flex';
                mobileControls.style.display = 'none';
            }

            // Menu events
            hamburgerMenu.addEventListener('click', toggleMobileMenu);
            closeMenu.addEventListener('click', closeMobileMenu);
            menuBackdrop.addEventListener('click', (e) => {
                if (e.target === menuBackdrop) {
                    closeMobileMenu();
                }
            });

            // Keyboard event listener
            document.addEventListener('keypress', handleKeyPress);
        });
    </script>
</body>
</html>